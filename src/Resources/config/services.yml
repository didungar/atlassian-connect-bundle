parameters:
    atlassian_connect_license_listener_class: AtlassianConnectBundle\Listener\LicenseListener
    atlassian_connect_jwt_user_provider_class: AtlassianConnectBundle\Security\JWTUserProvider
    atlassian_connect_jwt_authenticator_class: AtlassianConnectBundle\Security\LegacyJWTAuthenticator
    atlassian_connect_jwt_authenticator_class_new: AtlassianConnectBundle\Security\JWTAuthenticator
    atlassian_connect_tenant_entity_class: AtlassianConnectBundle\Entity\Tenant

services:
    _defaults:
        public: true
        autowire: false
        autoconfigure: true

    AtlassianConnectBundle\Controller\:
        resource: '../../Controller'
        tags: ['controller.service_arguments']

    AtlassianConnectBundle\Controller\UnlicensedController:
        arguments:
            $twig: '@twig'

    AtlassianConnectBundle\Controller\HandshakeController:
        arguments:
            $em: '@Doctrine\ORM\EntityManagerInterface'
            $logger: '@Psr\Log\LoggerInterface'
            $tenantClass: '%atlassian_connect_tenant_entity_class%'

    AtlassianConnectBundle\Controller\DescriptorController:
        arguments:
            $env: '%kernel.environment%'
            $config: '%atlassian_connect%'

    AtlassianConnectBundle\Command\RequestAPICommand:
        public: false
        arguments:
            $registry: '@Doctrine\Persistence\ManagerRegistry'
            $tenantClass: '%atlassian_connect_tenant_entity_class%'

    AtlassianConnectBundle\Service\AtlassianRestClient:
        arguments:
            $tenant: null
            $tokenStorage: '@Symfony\Component\Security\Core\Authentication\Token\Storage\TokenStorageInterface'

    AtlassianConnectBundle\Security\JWTSecurityHelper:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
            $devTenant: '%atlassian_connect_dev_tenant%'
            $environment: '%kernel.environment%'
            $tenantEntityClass: '%atlassian_connect_tenant_entity_class%'

    AtlassianConnectBundle\Security\JWTSecurityHelperInterface: '@AtlassianConnectBundle\Security\JWTSecurityHelper'

    kernel.listener.license_listener:
        class: '%atlassian_connect_license_listener_class%'
        arguments:
            $router: '@Symfony\Component\Routing\RouterInterface'
            $tokenStorage: '@Symfony\Component\Security\Core\Authentication\Token\Storage\TokenStorageInterface'
        tags:
            - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }

    jwt_user_provider:
        class: '%atlassian_connect_jwt_user_provider_class%'
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
            $tenantClass: '%atlassian_connect_tenant_entity_class%'

    jwt_authenticator:
        class: "%atlassian_connect_jwt_authenticator_class%"
        arguments:
            - '@AtlassianConnectBundle\Security\JWTSecurityHelperInterface'

    new_jwt_authenticator:
        class: "%atlassian_connect_jwt_authenticator_class_new%"
        arguments:
            - '@jwt_user_provider'
            - '@AtlassianConnectBundle\Security\JWTSecurityHelperInterface'

    AtlassianConnectBundle\Security\JWTAuthenticator: '@new_jwt_authenticator'
